{% extends "base.html" %}

{% block title %}{{ product.name }} - Reviews{% endblock %}

{% block content %}
<div class="container">
    <!-- Product Header -->
    <div style="margin: 2rem 0;">
        <a href="{% if session.role == 'FARMER' %}{{ url_for('farmer_dashboard') }}{% else %}{{ url_for('buyer_dashboard') }}{% endif %}" style="color: var(--primary-green); font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            <span>‚Üê</span>
            <span>Back</span>
        </a>
        <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--gray-900); margin-bottom: 0.5rem;">
            {{ product.name }}
        </h1>
        <p style="color: var(--gray-600); font-size: 1.125rem;">
            Sold by: {{ product.farmer_name }}
        </p>
    </div>

    <div class="grid grid-2" style="align-items: start;">
        <!-- Reviews Section -->
        <div>
            <!-- Rating Summary -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">Customer Reviews</h3>
                </div>
                <div class="card-body">
                    {% if stats and stats.total_reviews > 0 %}
                    <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: 800; color: var(--primary-green);">
                                {{ "%.1f"|format(stats.avg_rating) }}
                            </div>
                            <div style="color: var(--accent-orange); font-size: 1.5rem; margin: 0.5rem 0;">
                                ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.875rem;">
                                {{ stats.total_reviews }} reviews
                            </div>
                        </div>
                        
                        <div style="flex: 1;">
                            {% for rating in [5, 4, 3, 2, 1] %}
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.875rem; color: var(--gray-600); width: 60px;">{{ rating }} stars</span>
                                <div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                    {% set count = stats['%s_star'|format(['five', 'four', 'three', 'two', 'one'][5-rating])] %}
                                    {% set percentage = (count / stats.total_reviews * 100) if stats.total_reviews > 0 else 0 %}
                                    <div style="height: 100%; width: {{ percentage }}%; background: var(--accent-orange);"></div>
                                </div>
                                <span style="font-size: 0.875rem; color: var(--gray-600); width: 40px;">{{ count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚≠ê</div>
                        <p>No reviews yet. Be the first to review!</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Individual Reviews -->
            {% if reviews %}
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                {% for review in reviews %}
                <div class="card">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">
                                    {{ review.reviewer_name }}
                                    {% if review.isVerifiedPurchase %}
                                    <span class="badge badge-success" style="margin-left: 0.5rem; font-size: 0.75rem;">‚úì Verified Purchase</span>
                                    {% endif %}
                                </div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">
                                    {{ review.createdAt.strftime('%B %d, %Y') }}
                                </div>
                            </div>
                            <div style="color: var(--accent-orange); font-size: 1.25rem;">
                                {% for i in range(review.rating) %}‚≠ê{% endfor %}
                            </div>
                        </div>
                        
                        {% if review.title %}
                        <h4 style="font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem;">
                            {{ review.title }}
                        </h4>
                        {% endif %}
                        
                        {% if review.comment %}
                        <p style="color: var(--gray-700); line-height: 1.6;">
                            {{ review.comment }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Add Review Form (for buyers who purchased) -->
        <div style="position: sticky; top: 100px;">
            {% if can_review %}
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Write a Review ‚úçÔ∏è</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_review', product_id=product.id) }}">
                        <div class="form-group">
                            <label class="form-label">Rating</label>
                            <div style="display: flex; gap: 0.5rem; font-size: 2rem;">
                                {% for i in range(1, 6) %}
                                <label style="cursor: pointer;">
                                    <input type="radio" name="rating" value="{{ i }}" required style="display: none;">
                                    <span class="star" data-rating="{{ i }}" style="color: var(--gray-300); transition: var(--transition);">‚≠ê</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="title" class="form-label">Review Title (Optional)</label>
                            <input type="text" id="title" name="title" class="form-control" placeholder="Sum up your experience">
                        </div>
                        
                        <div class="form-group">
                            <label for="comment" class="form-label">Your Review</label>
                            <textarea id="comment" name="comment" class="form-control" rows="5" placeholder="Share your experience with this product..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span>‚úì</span>
                            <span>Submit Review</span>
                        </button>
                    </form>
                </div>
            </div>
            {% elif session.role == 'BUYER' %}
            <div class="card" style="background: var(--gray-50); padding: 2rem; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">üîí</div>
                {% if already_reviewed %}
                <h4 style="font-weight: 700; color: var(--gray-700); margin-bottom: 0.5rem;">Already Reviewed</h4>
                <p style="color: var(--gray-600); font-size: 0.875rem;">You've already submitted a review for this product</p>
                {% elif not has_purchased %}
                <h4 style="font-weight: 700; color: var(--gray-700); margin-bottom: 0.5rem;">Purchase Required</h4>
                <p style="color: var(--gray-600); font-size: 0.875rem;">Buy this product to leave a review</p>
                <a href="{{ url_for('buyer_dashboard') }}" class="btn btn-primary btn-sm" style="margin-top: 1rem;">
                    Browse Products
                </a>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Product Info Card -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title">Product Details</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <div style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.25rem;">Price</div>
                            <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary-green);">‚Çπ{{ "%.2f"|format(product.price) }}</div>
                        </div>
                        <div>
                            <div style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.25rem;">Stock Available</div>
                            <div style="font-weight: 700; color: var(--gray-900);">{{ product.stockQuantity }} units</div>
                        </div>
                        <div>
                            <div style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.25rem;">Average Rating</div>
                            <div style="font-size: 1.25rem; color: var(--accent-orange);">
                                {% if product.averageRating %}
                                ‚≠ê {{ "%.1f"|format(product.averageRating) }}
                                {% else %}
                                No ratings yet
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Star rating interactivity
document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function() {
        const rating = this.dataset.rating;
        document.querySelectorAll('.star').forEach(s => {
            const sRating = parseInt(s.dataset.rating);
            if (sRating <= rating) {
                s.style.color = 'var(--accent-orange)';
            } else {
                s.style.color = 'var(--gray-300)';
            }
        });
        this.previousElementSibling.checked = true;
    });
    
    star.addEventListener('mouseenter', function() {
        const rating = this.dataset.rating;
        document.querySelectorAll('.star').forEach(s => {
            const sRating = parseInt(s.dataset.rating);
            if (sRating <= rating) {
                s.style.color = 'var(--accent-orange)';
            } else {
                s.style.color = 'var(--gray-300)';
            }
        });
    });
});

document.querySelector('form')?.addEventListener('mouseleave', function() {
    const checked = document.querySelector('input[name="rating"]:checked');
    if (checked) {
        const rating = checked.value;
        document.querySelectorAll('.star').forEach(s => {
            const sRating = parseInt(s.dataset.rating);
            if (sRating <= rating) {
                s.style.color = 'var(--accent-orange)';
            } else {
                s.style.color = 'var(--gray-300)';
            }
        });
    } else {
        document.querySelectorAll('.star').forEach(s => {
            s.style.color = 'var(--gray-300)';
        });
    }
});
</script>
{% endblock %}
